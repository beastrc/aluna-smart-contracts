<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/PaymentReceiver.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> PaymentReceiver.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>23/23</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">64.29% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>9/14</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>6/6</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>23/23</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">27×</span>
<span class="cline-any cline-yes">27×</span>
<span class="cline-any cline-yes">27×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">34×</span>
<span class="cline-any cline-yes">34×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">pragma solidity ^0.5.6;
&nbsp;
import "@openzeppelin/contracts/ownership/Ownable.sol";
import "@openzeppelin/contracts/token/ERC20/ERC20.sol";
import "./RewardsPool.sol";
&nbsp;
contract PaymentReceiver is ERC20, Ownable {
&nbsp;
    struct Payment {
        uint256 value;
        uint256 poolFee;
        bool refunded;
    }
&nbsp;
    mapping(bytes32 =&gt; Payment) public payments;
&nbsp;
    address public rewardsPoolAddress;
&nbsp;
    uint256 public rewardsPoolPercentage;
&nbsp;
    /**
      * @dev Payment Event To Rewards Pool
      * @param sender The address who is making the payment
      * @param value ALN token amount
      * @param paymentId payment ID
    */
    event PaymentProcessed(address sender, uint256 value, bytes32 indexed paymentId);
&nbsp;
    /**
      * @dev Refund Payment Event To Sender
      * @param sender The address who is making the payment
      * @param value ALN token amount
      * @param paymentId payment ID
    */
    event PaymentRefunded(address sender, uint256 value, bool refunded, bytes32 indexed paymentId);
&nbsp;
    /**
      * @dev Set rewards pool percentage share of payments
      * @param _rewardsPoolPercentage new percentage share
    */
    function setRewardsPoolPercentage(uint256 _rewardsPoolPercentage) public onlyOwner {
        _setRewardsPoolPercentage(_rewardsPoolPercentage);
    }
&nbsp;
    /**
      * @dev Set rewards pool address
      * @param _rewardsPoolAddress new rewards pool address
    */
    function setRewardsPoolAddress(address _rewardsPoolAddress) public onlyOwner {
        _setRewardsPoolAddress(_rewardsPoolAddress);
    }
&nbsp;
    /**
    * @dev Withdraws the ALN balance of the sender to the owner adddress,
    * and sends a percentage to the Rewards Pool.
    * Assumes percentages are whole numbers, 5 would be 5%.
    * Converts rewards pool percentage to amount and subtracts from total amount.
    * Emits `PaymentProcessed` when the payment is processed succesfully
    * @param _value amount ALN tokens to transfer.
    * @param _paymentId id of the payment provided by Aluna.
    */
    function processPayment(uint256 _value, bytes32 _paymentId) public {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_value &gt; 0, "PaymentProcessor: non-positive payment value");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_paymentId != 0x0, "PaymentProcessor: invalid payment id");
        require(payments[_paymentId].value == 0, "PaymentProcessor: payment id already used");
        uint256 _rewardsPoolAmount = (_value.mul(rewardsPoolPercentage)).div(100);
        uint256 _remainingAmount = _value.sub(_rewardsPoolAmount);
        _transfer(msg.sender, owner(), _remainingAmount);
        _approve(msg.sender, rewardsPoolAddress, _rewardsPoolAmount);
        RewardsPool(rewardsPoolAddress).deposit(msg.sender, _rewardsPoolAmount);
        emit PaymentProcessed(msg.sender, _value, _paymentId);
        payments[_paymentId] = Payment(_value, _rewardsPoolAmount, false);
    }
&nbsp;
    /**
    * @dev Refunds total or partial balance of a payment
    * Assumes percentages are whole numbers, 5 would be 5%.
    * Emits `PaymentRefunded` when the payment is refunded succesfully
    * @param _sender the sender of the payment to be refunded
    * @param _paymentId id of the payment provided by Aluna.
    */
    function refundPayment(address _sender, bytes32 _paymentId) public onlyOwner {
        require(!payments[_paymentId].refunded, "PaymentProcessor: payment already refunded");
        uint256 value_to_refund = payments[_paymentId].value;
        _transfer(owner(), _sender, payments[_paymentId].value.sub(payments[_paymentId].poolFee));
        _transfer(rewardsPoolAddress, _sender, payments[_paymentId].poolFee);
        payments[_paymentId].refunded = true;
        emit PaymentRefunded(_sender, value_to_refund, payments[_paymentId].refunded, _paymentId);
    }
&nbsp;
    /**
      * @dev Set rewards pool percentage share of payments
      * @param _rewardsPoolPercentage new percentage share
    */
    function _setRewardsPoolPercentage(uint256 _rewardsPoolPercentage) internal {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_rewardsPoolPercentage &gt;= 0, "PaymentProcessor: rewards pool percentage is not 0 or above");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_rewardsPoolPercentage &lt;= 100, "PaymentProcessor: rewards pool percentage is not 100 or lower");
        rewardsPoolPercentage = _rewardsPoolPercentage;
    }
&nbsp;
    /**
      * @dev Set rewards pool address
      * @param _rewardsPoolAddress new rewards pool address
    */
    function _setRewardsPoolAddress(address _rewardsPoolAddress) internal {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_rewardsPoolAddress != address(0), "PaymentProcessor: invalid rewards pool address");
        rewardsPoolAddress = _rewardsPoolAddress;
    }
&nbsp;
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Tue Sep 08 2020 02:32:34 GMT+0100 (British Summer Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
